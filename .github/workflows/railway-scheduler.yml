name: Railway AI Service Scheduler

# Schedule: 
# Start at 6:00 AM IST (12:30 AM UTC) - IST is UTC+5:30
# Stop at 1:00 AM IST (7:30 PM UTC previous day)

on:
  schedule:
    # Start service at 6:00 AM IST = 00:30 UTC
    - cron: '30 0 * * *'
    # Stop service at 1:00 AM IST = 19:30 UTC (previous day)
    - cron: '30 19 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'start'
        type: choice
        options:
          - start
          - stop

jobs:
  manage-service:
    runs-on: ubuntu-latest
    steps:
      - name: Determine Action
        id: action
        run: |
          # Check if this is a manual trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
          else
            # Scheduled trigger - determine based on cron time
            HOUR=$(date -u +%H)
            MINUTE=$(date -u +%M)
            # If it's around 00:30 UTC (6 AM IST) -> start
            # If it's around 19:30 UTC (1 AM IST) -> stop
            if [ "$HOUR" -lt "12" ]; then
              echo "action=start" >> $GITHUB_OUTPUT
            else
              echo "action=stop" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Start Railway Service
        if: steps.action.outputs.action == 'start'
        run: |
          echo "Starting Railway AI service..."
          curl -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { serviceInstanceRedeploy(serviceId: \"${{ secrets.RAILWAY_SERVICE_ID }}\") }"
            }'
          echo "Service start command sent!"

      - name: Stop Railway Service  
        if: steps.action.outputs.action == 'stop'
        run: |
          echo "Stopping Railway AI service..."
          # Railway doesn't have a direct stop API, so we scale replicas to 0
          curl -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { serviceInstanceUpdate(serviceId: \"${{ secrets.RAILWAY_SERVICE_ID }}\", input: { numReplicas: 0 }) { id } }"
            }'
          echo "Service stop command sent!"

      - name: Log Action
        run: |
          echo "Action performed: ${{ steps.action.outputs.action }}"
          echo "Time (UTC): $(date -u)"
          echo "Time (IST): $(TZ='Asia/Kolkata' date)"
